<!doctype html>
<html lang="fr">
<head>
  <link rel="icon" type="image/png" href="logo.png" />
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kfet INSA CVL ‚Äî Statistiques</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            kfetBg: '#ffd0be',
            kfetAccent: '#fc8207'
          }
        }
      }
    }
  </script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    .card {
      background: white;
      border-radius: 0.5rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      padding: 1rem;
    }
  </style>
</head>

<body class="bg-kfetBg text-gray-800 min-h-screen">
  <!-- HEADER -->
  <header class="bg-white shadow-sm">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between">
      <a href="index.html" class="flex items-center gap-3">
        <img src="logo.png" alt="Kfet logo" class="w-10 h-10 rounded-full object-cover" />
        <div><h1 class="text-lg font-semibold">Statistiques ‚Äî Kfet INSA CVL</h1></div>
      </a>
      <div class="flex gap-3">
        <a href="admin.html" class="text-sm text-gray-700 hover:underline">Admin</a>
        <a href="index.html" class="text-sm text-gray-700 hover:underline">Retour √† la page principale</a>
      </div>
    </div>
  </header>

  <!-- MAIN -->
  <main class="max-w-6xl mx-auto p-4 space-y-6">
    <!-- Panini Nutella count -->
    <section class="card text-center">
      <h2 class="text-xl font-semibold mb-2">ü•ê Paninis Nutella command√©s</h2>
      <p id="nutellaCount" class="text-3xl font-bold text-kfetAccent">0</p>
    </section>

    <!-- Global distribution -->
    <section class="card">
      <h2 class="text-xl font-semibold mb-4">R√©partition des plats</h2>
      <canvas id="chartPlats" height="100"></canvas>
    </section>

    <!-- Top 3 -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">
      <section class="card">
        <h3 class="text-lg font-semibold mb-2">Top 3 Plats</h3>
        <ul id="topPlats" class="list-decimal pl-6 space-y-1"></ul>
      </section>
      <section class="card">
        <h3 class="text-lg font-semibold mb-2">Top 3 Desserts</h3>
        <ul id="topDesserts" class="list-decimal pl-6 space-y-1"></ul>
      </section>
      <section class="card">
        <h3 class="text-lg font-semibold mb-2">Top 3 Boissons</h3>
        <ul id="topBoissons" class="list-decimal pl-6 space-y-1"></ul>
      </section>
    </div>
  </main>

  <footer class="max-w-6xl mx-auto p-4 text-center text-sm text-gray-500">
    Statistiques calcul√©es √† partir des commandes locales
  </footer>

  <script src="script.js"></script>
  <script>
    const orders = kfet.loadOrders().concat(kfet.loadArchive());
    if (orders.length === 0) {
      alert("Aucune donn√©e disponible pour les statistiques !");
    }

    // ---- Panini Nutella count ----
    const nutellaCount = orders.filter(o => o.plat?.toLowerCase().includes("nutella")).length;
    document.getElementById("nutellaCount").textContent = nutellaCount;

    // ---- Count helper ----
    function countByKey(arr, key) {
      const map = {};
      arr.forEach(o => {
        const val = (o[key] || "").trim();
        if (!val || val === "Aucune" || val === "Aucun") return;
        map[val] = (map[val] || 0) + 1;
      });
      return map;
    }

    // ---- Distribution of plat types ----
    const plats = orders.map(o => o.plat || "");
    const types = { Pizza: 0, Panini: 0, Salade: 0, "Pasta Box / Lasagnes": 0 };
    plats.forEach(p => {
      const l = p.toLowerCase();
      if (l.includes("pizza")) types.Pizza++;
      else if (l.includes("panini")) types.Panini++;
      else if (l.includes("salad")) types.Salade++;
      else if (l.includes("pasta") || l.includes("lasag")) types["Pasta Box / Lasagnes"]++;
    });

    new Chart(document.getElementById("chartPlats"), {
      type: "doughnut",
      data: {
        labels: Object.keys(types),
        datasets: [{
          data: Object.values(types),
          backgroundColor: ["#f87171", "#facc15", "#16a34a", "#8b5e3c"],
        }],
      },
      options: {
        plugins: { legend: { position: "bottom" } }
      }
    });

    // ---- Top 3 lists ----
    function renderTop(containerId, map) {
      const sorted = Object.entries(map).sort((a,b)=>b[1]-a[1]).slice(0,3);
      const ul = document.getElementById(containerId);
      ul.innerHTML = sorted.length ? "" : "<li>Aucune donn√©e</li>";
      sorted.forEach(([name, count], i) => {
        const li = document.createElement("li");
        li.textContent = `${name} (${count})`;
        ul.appendChild(li);
      });
    }

    renderTop("topPlats", countByKey(orders, "plat"));
    renderTop("topDesserts", countByKey(orders, "dessert"));
    renderTop("topBoissons", countByKey(orders, "boisson"));
  </script>
</body>
</html>
